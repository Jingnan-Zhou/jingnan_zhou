<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>海龟汤 - AI互动版</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #e0f7fa 0%, #fffde4 100%);
      font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: #ffffffcc;
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 188, 212, 0.12);
      padding: 32px 24px 24px 24px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 350px;
      max-width: 95vw;
    }
    .title {
      font-size: 2rem;
      color: #0097a7;
      margin-bottom: 10px;
      letter-spacing: 2px;
    }
    .subtitle {
      font-size: 1.1rem;
      color: #666;
      margin-bottom: 18px;
    }
    .story {
      background: #e0f7fa;
      border-radius: 12px;
      padding: 16px 18px;
      color: #00796b;
      font-size: 1.1rem;
      margin-bottom: 18px;
      min-width: 260px;
      max-width: 400px;
      text-align: center;
    }
    .chat-area {
      width: 100%;
      max-width: 400px;
      min-height: 180px;
      background: #f7fafd;
      border-radius: 10px;
      padding: 12px 10px;
      margin-bottom: 16px;
      overflow-y: auto;
      box-sizing: border-box;
      border: 1px solid #b2ebf2;
    }
    .msg {
      margin: 8px 0;
      display: flex;
      flex-direction: column;
    }
    .msg.user {
      align-items: flex-end;
    }
    .msg.ai {
      align-items: flex-start;
    }
    .msg .bubble {
      display: inline-block;
      padding: 8px 14px;
      border-radius: 16px;
      font-size: 1rem;
      max-width: 80%;
      word-break: break-all;
    }
    .msg.user .bubble {
      background: #b2ebf2;
      color: #006064;
      border-bottom-right-radius: 4px;
    }
    .msg.ai .bubble {
      background: #fffde4;
      color: #8d6e63;
      border-bottom-left-radius: 4px;
    }
    .input-area {
      display: flex;
      width: 100%;
      max-width: 400px;
      gap: 8px;
      margin-top: 8px;
    }
    .input-area input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #b2ebf2;
      font-size: 1rem;
      outline: none;
    }
    .input-area button {
      background: #00bcd4;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .input-area button:hover {
      background: #0097a7;
    }
    .loading {
      color: #00bcd4;
      font-size: 1rem;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">海龟汤 · AI互动版</div>
    <div class="subtitle">AI出题，提问推理，猜出真相！</div>
    <div class="story" id="story">正在生成题目，请稍候...</div>
    <div class="chat-area" id="chat-area"></div>
    <form class="input-area" id="input-form">
      <input type="text" id="user-input" placeholder="请输入你的提问或猜测..." autocomplete="off" required />
      <button type="submit">发送</button>
    </form>
    <div class="loading" id="loading" style="display:none;">AI思考中...</div>
    <div class="btn-area" style="display:flex;gap:10px;margin-top:10px;justify-content:center;">
      <button id="btn-reset">换题</button>
      <button id="btn-hint">提示</button>
      <button id="btn-answer">揭晓谜底</button>
    </div>
    <!-- 反馈弹窗 -->
    <div id="feedback-dialog" style="display:none;position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px 30px;border-radius:12px;box-shadow:0 2px 16px #0002;z-index:999;">
      <div style="margin-bottom:10px;">请反馈AI判断：</div>
      <select id="feedback-type">
        <option value="判断不准确">AI判断不准确</option>
        <option value="其他">其他</option>
      </select>
      <div style="margin-top:12px;">
        <button id="feedback-submit">提交</button>
        <button id="feedback-cancel">取消</button>
      </div>
    </div>
  </div>
  <script>
    // DeepSeek API Key
    const API_KEY = 'sk-xxxxxxxxxxxxxxxxx'; // 用户提供的DeepSeek API密钥
    const API_URL = 'https://api.deepseek.com'; // DeepSeek官方API地址

    // 本地海龟汤题库
    const turtleSoupList = [
      { question: '男子在餐厅喝了一口海龟汤后冲出店门自杀，桌上有一张缺巴巴的报纸。', answer: '男子是逃犯，报纸刊登了通缉令照片，他喝汤时发现自己被老板认出，畏罪自杀。' },
      { question: '盲人冷感更明自杀，临终前撕毁了所有信件。', answer: '他复明后发现信件是家人伪造的"女友"笔迹，意识到从未被爱过。' },
      { question: '探险家沙漠中变得异常渴死，口中有水。', answer: '海龟负责开宴做海水汤，但他说喝来并非真海水，推测被换成了淡化的水导致中毒。' },
      { question: '女孩路障锐利撞宽，公园雕塑失头飘过河而湿沙，最终遗亡在浴缸。', answer: '她梦游时撞击雕塑流血，湿沙是法士供奉遗物，最终梦游时滑倒溺水。' },
      { question: '雷浴池爆炸案件调查一片莫顿颅骨和自冰冰，子女踩做后泳池突然爆炸。', answer: '砚巾中的针写冰池氯水发生化学反应，产生氯气体遇火花化爆炸。' },
      { question: '男子在葬礼上对陌生女子一见钟情，数日后杀害亲姐姐。', answer: '姐姐是整容医生，女子是姐姐亲生骨肉，反口罩掩盖非法交易。' },
      { question: '医生给病人注射"生理盐水"后病人死亡，病情检查无异常。', answer: '医生是色盲，误将氯化钾注射溶液当作生理盐水（二者标签颜色不同）。' },
      { question: '他用宠物的血写小说，宠物死后自杀。', answer: '他用宠物的血写小说，宠物死后他自杀。' },
      { question: '逃犯冰湖逃犯打，逃犯跳入结冰湖泊和留有冰洞和留有气泡。', answer: '逃犯足迹等特征暴露，若翻转冰块可打洞灌灌雪，跳入后痕迹消失而呼吸留留气泡。' },
      { question: '男子用电器实验死亡，留下了一道细水水痕。', answer: '他使用电器致死，拉子触碰被水打漏电，水痕是起跑时电解出的酸液。' },
      { question: '努力寻找真实死因后，孩子口有一道细水水痕。', answer: '家族遗有怪异体质难被发现，物证源于外，渗入原水外。' },
      { question: '他用骨灰撒在海里，骨灰却浮在水面。', answer: '他用特殊的骨灰结构，分离DNA确认身份。' },
      { question: '区手库使使使，提前在床垫夹层遗体格，逐诗诗字支接保入后绑架。', answer: '区手库使使使，提前在床垫夹层遗体格，逐诗诗字支接保入后绑架。' },
      { question: '宾客查机票，机长延迟起飞，仪表盘显示高度为0。', answer: '飞机始终未起飞，机长释放惰眠气体后自杀，高度表被提前更改。' }
    ];
    let currentSoup = null;

    // 游戏上下文
    let story = '';
    let chatHistory = [];
    let systemPrompt = `你是一个海龟汤推理游戏的裁判。你只允许用"是"、"否"或"无关"来回答用户的每一个提问，绝不允许输出其他内容。只有在用户请求提示时，才可以输出简短提示。请严格根据题目和标准答案判断，务必准确。`;

    // 页面元素
    const storyDiv = document.getElementById('story');
    const chatArea = document.getElementById('chat-area');
    const inputForm = document.getElementById('input-form');
    const userInput = document.getElementById('user-input');
    const loadingDiv = document.getElementById('loading');

    // 工具函数
    let lastUserInput = '';
    let lastAIReply = '';
    function appendMsg(role, text) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'msg ' + (role === 'user' ? 'user' : 'ai');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.innerText = text;
      msgDiv.appendChild(bubble);
      // 如果是AI消息，添加反馈按钮
      if (role === 'ai') {
        const feedbackBtn = document.createElement('button');
        feedbackBtn.innerText = '反馈';
        feedbackBtn.className = 'feedback-btn';
        feedbackBtn.style.marginLeft = '8px';
        feedbackBtn.onclick = function() {
          showFeedbackDialog(text);
        };
        msgDiv.appendChild(feedbackBtn);
      }
      chatArea.appendChild(msgDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
    function setLoading(show) {
      loadingDiv.style.display = show ? '' : 'none';
    }
    // 反馈弹窗逻辑
    function showFeedbackDialog(aiReply) {
      document.getElementById('feedback-dialog').style.display = '';
      lastAIReply = aiReply;
    }
    document.getElementById('feedback-cancel').onclick = function() {
      document.getElementById('feedback-dialog').style.display = 'none';
    };
    document.getElementById('feedback-submit').onclick = function() {
      const type = document.getElementById('feedback-type').value;
      const feedback = {
        question: currentSoup ? currentSoup.question : '',
        userInput: lastUserInput,
        aiReply: lastAIReply,
        type,
        time: new Date().toISOString()
      };
      let feedbacks = JSON.parse(localStorage.getItem('turtleSoupFeedbacks') || '[]');
      feedbacks.push(feedback);
      localStorage.setItem('turtleSoupFeedbacks', JSON.stringify(feedbacks));
      document.getElementById('feedback-dialog').style.display = 'none';
      alert('感谢您的反馈！我们会用于优化AI判断。');
    };
    // 获取历史反馈，拼接到system prompt
    function getFeedbackPrompt() {
      let feedbacks = JSON.parse(localStorage.getItem('turtleSoupFeedbacks') || '[]');
      if (!currentSoup) return '';
      feedbacks = feedbacks.filter(f => f.question === currentSoup.question);
      if (feedbacks.length === 0) return '';
      let prompt = '\n历史用户反馈：\n';
      feedbacks.forEach(f => {
        prompt += `用户提问："${f.userInput}"，AI回复："${f.aiReply}"，用户反馈："${f.type}"\n`;
      });
      prompt += '请参考以上反馈，优化你的判断。';
      return prompt;
    }

    // 随机抽题
    function pickRandomSoup() {
      const idx = Math.floor(Math.random() * turtleSoupList.length);
      currentSoup = turtleSoupList[idx];
      story = currentSoup.question;
      storyDiv.innerText = story;
    }

    // 生成海龟汤题目（本地）
    function generateStory() {
      setLoading(true);
      pickRandomSoup();
      setLoading(false);
    }

    // 处理用户输入
    async function handleUserInput(input) {
      lastUserInput = input;
      appendMsg('user', input);
      setLoading(true);
      chatHistory.push({ role: 'user', content: input });
      // 构造对话历史
      const messages = [
        { role: 'system', content: systemPrompt + getFeedbackPrompt() + `\n当前题目：${currentSoup.question}\n标准答案：${currentSoup.answer}` },
        { role: 'assistant', content: currentSoup.question },
        ...chatHistory
      ];
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: 'deepseek-reasoner',
            messages: messages,
            temperature: 0.5
          })
        });
        const data = await res.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
          throw new Error('AI返回格式异常');
        }
        const aiReply = data.choices[0].message.content.trim();
        appendMsg('ai', aiReply);
        setLoading(false);
      } catch (e) {
        console.error(e);
        appendMsg('ai', 'AI回答失败，请重试。');
        setLoading(false);
      }
    }

    // 事件绑定
    inputForm.onsubmit = function(e) {
      e.preventDefault();
      const input = userInput.value.trim();
      if (!input) return;
      handleUserInput(input);
      userInput.value = '';
    };

    function resetGame() {
      chatHistory = [];
      generateStory();
      chatArea.innerHTML = '';
    }

    // 按钮功能
    document.getElementById('btn-reset').onclick = function() {
      resetGame();
    };
    document.getElementById('btn-hint').onclick = async function() {
      setLoading(true);
      const messages = [
        { role: 'system', content: systemPrompt + getFeedbackPrompt() + `\n当前题目：${currentSoup.question}\n标准答案：${currentSoup.answer}` },
        { role: 'assistant', content: currentSoup.question },
        ...chatHistory,
        { role: 'user', content: '请给我一个简短的提示，不要直接揭晓答案。' }
      ];
      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEY}`
          },
          body: JSON.stringify({
            model: 'deepseek-reasoner',
            messages: messages,
            temperature: 0.7
          })
        });
        const data = await res.json();
        if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
          throw new Error('AI返回格式异常');
        }
        appendMsg('ai', '[提示] ' + data.choices[0].message.content.trim());
        setLoading(false);
      } catch (e) {
        console.error(e);
        appendMsg('ai', '获取提示失败，请重试。');
        setLoading(false);
      }
    };
    document.getElementById('btn-answer').onclick = function() {
      appendMsg('ai', '[谜底] ' + currentSoup.answer);
    };

    // 初始化
    generateStory();
  </script>
</body>
</html> 
